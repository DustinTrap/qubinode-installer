---
- hosts: nodes
  remote_user: "{{ ansible_ssh_user }}"
  become: yes
  vars_files:
  - vars/all.yml
  - vars/vault.yml
  tasks:
  - name: update resolve.conf to point to idm
    blockinfile:
      path: /etc/resolv.conf
      block: |
        nameserver {{ idm_public_ip }}
        nameserver 8.8.8.8
  - name: refresh subscription-manager
    command: subscription-manager refresh
    when:
      - ansible_distribution == "RedHat"

  - name: auto attach to  subscription-manager
    command: subscription-manager attach --auto
    when:
      - ansible_distribution == "RedHat"

  - name: ensure system is registered to Red Hat
    include_role:
      name: swygue-redhat-subscription

  - name: Attach a specific subscription through the Customer Portal
    command: subscription-manager refresh
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-rpms repository
    rhsm_repository:
      name: rhel-7-server-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-extras-rpms repository
    rhsm_repository:
      name: rhel-7-server-extras-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-ose-3.11-rpms repository
    rhsm_repository:
      name: rhel-7-server-ose-3.11-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-fast-datapath-rpms repository
    rhsm_repository:
      name: rhel-7-fast-datapath-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-ansible-2.6-rpms repository
    rhsm_repository:
      name: rhel-7-server-ansible-2.6-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-optional-rpms repository
    rhsm_repository:
      name: rhel-7-server-optional-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: upgrade all packages
    yum:
      name: '*'
      state: latest
  - name: install base packages
    yum:
      name:
      - wget
      - git
      - net-tools
      - bind-utils
      - yum-utils
      - iptables-services
      - bridge-utils
      - bash-completion
      - kexec-tools
      - sos
      - psacct
      state: present
  - name: Install docker-1.13.1
    yum:
      name:
        - docker-1.13.1
    when:
      - ansible_distribution == "RedHat"
  - name: cleanup hosts files on openshift nodes
    synchronize:
      src: /etc/hosts
      dest: /etc/hosts
    become: yes
  - name: update hosts file with node ip
    shell: |
        CHECKFORENTRY=$(cat /etc/hosts | grep $HOSTNAME)
        if [[ -z $CHECKFORENTRY ]]; then
          echo "{{ ansible_default_ipv4.address }} $HOSTNAME" >> /etc/hosts
        fi
  - name: create docker-storage-setup file
    copy:
      dest: "/etc/sysconfig/docker-storage-setup"
      content: |
        STORAGE_DRIVER=overlay2
        DEVS=/dev/vdb
        VG=docker-vg
    when:
      - ansible_distribution == "RedHat"
  - name: Run  docker-storage-setup
    command: docker-storage-setup
    when:
      - ansible_distribution == "RedHat"
